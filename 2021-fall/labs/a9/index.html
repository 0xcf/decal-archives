

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="/assets/css/just-the-docs-default.css">

  

  
    <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Lab 9 - Security | Sysadmin DeCal</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Lab 9 - Security" />
<meta name="author" content="Nikhil Jha, Ben Cuan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A course covering the basics of setting up and administering a production-quality Linux server environment." />
<meta property="og:description" content="A course covering the basics of setting up and administering a production-quality Linux server environment." />
<link rel="canonical" href="https://decal.ocf.io/archives/2021-fall/labs/a9/" />
<meta property="og:url" content="https://decal.ocf.io/archives/2021-fall/labs/a9/" />
<meta property="og:site_name" content="Sysadmin DeCal" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Lab 9 - Security" />
<script type="application/ld+json">
{"@type":"WebPage","author":{"@type":"Person","name":"Nikhil Jha, Ben Cuan"},"url":"https://decal.ocf.io/archives/2021-fall/labs/a9/","headline":"Lab 9 - Security","description":"A course covering the basics of setting up and administering a production-quality Linux server environment.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<span style="display: none">
  
@import "./support/support";
@import "./color_schemes/";
@import "./modules";
@import "./custom/custom";


</span>
<body>
  <div id="loading" style="height:140%;width:140%;background-color:#ffffff;position:absolute;z-index:1000;left:-20%;top:-20%"></div>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
      <title>Link</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    </symbol>
  </svg>
  <div class="side-bar lab-side-bar">
    <div class="site-header">
      <a href="/" class="site-title lh-tight">
        Sysadmin DeCal
      </a>
      <a href="#" id="menu-button" class="site-button">
        <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
      </a>
    </div>
    <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">      
      <button type="button" name="theme-toggle" class="btn theme-btn" onclick="toggleDark()">Toggle Dark Theme</button>
      <ol><li><a href="#overview">Overview</a><ol><li><a href="#getting-help">Getting help</a></li></ol></li><li><a href="#threat-models">Threat Models</a><ol><li><a href="#example-safekeeping">Example: Safekeeping</a></li><li><a href="#task-1-construct-your-own-threat-model">Task 1: Construct your own threat model</a></li></ol></li><li><a href="#security-building-blocks">Security Building Blocks</a><ol><li><a href="#encryption">Encryption</a><ol><li><a href="#a-brief-introduction">A Brief Introduction</a></li><li><a href="#types-of-encryption">Types of Encryption</a></li></ol></li><li><a href="#signatures-and-certificates">Signatures and Certificates</a></li><li><a href="#hashing">Hashing</a></li></ol></li><li><a href="#encryption-lab-activity">Encryption Lab Activity</a><ol><li><a href="#submission">Submission</a></li><li><a href="#introduction-making-ssh-keys">Introduction: Making SSH keys</a></li><li><a href="#warm-up-task">Warm-up Task</a></li><li><a href="#task-2---symmetric-encryption">Task 2 - Symmetric Encryption</a></li><li><a href="#task-3---asymmetric-encryption">Task 3 - Asymmetric Encryption</a></li><li><a href="#task-4---hashing">Task 4 - Hashing</a></li></ol></li><li><a href="#file-security">File Security</a><ol><li><a href="#file-security-and-permissions">File Security and Permissions</a></li><li><a href="#task-5---file-security">Task 5 - File Security</a></li></ol></li><li><a href="#network-security">Network Security</a><ol><li><a href="#task-6---network-security-lab-activity">Task 6 - Network Security Lab Activity</a></li></ol></li><li><a href="#optional-task-letsencrypt-on-an-nginx-instance">Optional Task: Letsencrypt on an nginx instance!</a></li></ol></li><li><a href="#footnotes">Footnotes</a></li></ol>

    </nav>
    </div>
  </div>
  <div id="main" class="main">
    <div id="main-content-wrap" class="main-content-wrap">
      
        
      
      <div id="main-content" class="main-content" role="main">
        <h1 style="margin-bottom:0">Lab 9 - Security</h1>
        
        <p>Facilitator: <a href="/staff#mark-zhang">Mark Zhang</a></p>
        
        
        34 min read
        
          <h2 class="no_toc text-delta" id="table-of-contents">
        
        
          <a href="#table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents
        
        
      </h2>
    

<ol id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a>    <ol>
      <li><a href="#getting-help" id="markdown-toc-getting-help">Getting help</a></li>
    </ol>
  </li>
  <li><a href="#threat-models" id="markdown-toc-threat-models">Threat Models</a>    <ol>
      <li><a href="#example-safekeeping" id="markdown-toc-example-safekeeping">Example: Safekeeping</a></li>
      <li><a href="#task-1-construct-your-own-threat-model" id="markdown-toc-task-1-construct-your-own-threat-model">Task 1: Construct your own threat model</a></li>
    </ol>
  </li>
  <li><a href="#security-building-blocks" id="markdown-toc-security-building-blocks">Security Building Blocks</a>    <ol>
      <li><a href="#encryption" id="markdown-toc-encryption">Encryption</a>        <ol>
          <li><a href="#a-brief-introduction" id="markdown-toc-a-brief-introduction">A Brief Introduction</a></li>
          <li><a href="#types-of-encryption" id="markdown-toc-types-of-encryption">Types of Encryption</a>            <ol>
              <li><a href="#symmetric-key-cryptography" id="markdown-toc-symmetric-key-cryptography">Symmetric Key Cryptography</a></li>
              <li><a href="#public-key-cryptography" id="markdown-toc-public-key-cryptography">Public Key Cryptography</a></li>
            </ol>
          </li>
        </ol>
      </li>
      <li><a href="#signatures-and-certificates" id="markdown-toc-signatures-and-certificates">Signatures and Certificates</a></li>
      <li><a href="#hashing" id="markdown-toc-hashing">Hashing</a></li>
    </ol>
  </li>
  <li><a href="#encryption-lab-activity" id="markdown-toc-encryption-lab-activity">Encryption Lab Activity</a>    <ol>
      <li><a href="#submission" id="markdown-toc-submission">Submission</a></li>
      <li><a href="#introduction-making-ssh-keys" id="markdown-toc-introduction-making-ssh-keys">Introduction: Making SSH keys</a></li>
      <li><a href="#warm-up-task" id="markdown-toc-warm-up-task">Warm-up Task</a></li>
      <li><a href="#task-2---symmetric-encryption" id="markdown-toc-task-2---symmetric-encryption">Task 2 - Symmetric Encryption</a></li>
      <li><a href="#task-3---asymmetric-encryption" id="markdown-toc-task-3---asymmetric-encryption">Task 3 - Asymmetric Encryption</a></li>
      <li><a href="#task-4---hashing" id="markdown-toc-task-4---hashing">Task 4 - Hashing</a></li>
      <li><a href="#file-security" id="markdown-toc-file-security">File Security</a>        <ol>
          <li><a href="#file-security-and-permissions" id="markdown-toc-file-security-and-permissions">File Security and Permissions</a></li>
          <li><a href="#task-5---file-security" id="markdown-toc-task-5---file-security">Task 5 - File Security</a></li>
        </ol>
      </li>
      <li><a href="#network-security" id="markdown-toc-network-security">Network Security</a>        <ol>
          <li><a href="#task-6---network-security-lab-activity" id="markdown-toc-task-6---network-security-lab-activity">Task 6 - Network Security Lab Activity</a></li>
        </ol>
      </li>
      <li><a href="#optional-task-letsencrypt-on-an-nginx-instance" id="markdown-toc-optional-task-letsencrypt-on-an-nginx-instance">Optional Task: Letsencrypt on an nginx instance!</a></li>
    </ol>
  </li>
  <li><a href="#footnotes" id="markdown-toc-footnotes">Footnotes</a></li>
</ol><hr />
      <h1 id="overview">
        
        
          <a href="#overview" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview
        
        
      </h1>
    
<p>In this lab, we will cover a variety of topics that are of interest to
those studying computer security. We will go much more in depth than you
need to know, so we hope you pick up the main practical concepts and dig
deeper if you are interested.</p>

<p>There are many aspects to security, and the field spans a number of
disciplines. We will cover the following:</p>

<ul>
  <li>Threat Models</li>
  <li>Security Building Blocks
    <ul>
      <li>Encryption - Symmetric and Public-Key Crypto</li>
      <li>Certs, Signatures</li>
      <li>Hashing</li>
    </ul>
  </li>
  <li>File Security</li>
  <li>Network Security</li>
</ul>
      <h2 id="getting-help">
        
        
          <a href="#getting-help" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Getting help
        
        
      </h2>
    
<p>If you want any help with any part of this lab, join the OCF slack/discord
(<a href="https://ocf.io/slack">https://ocf.io/slack</a>), and post your questions in <strong>#decal-general</strong>.</p>
      <h1 id="threat-models">
        
        
          <a href="#threat-models" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Threat Models
        
        
      </h1>
    

<p>The most important thing to remember when designing secure systems is
understanding your threat model. No system is guaranteed to be secure or able
to withstand all attacks, nor is this even possible in the face of extreme
adversaries. However, you can (and should) take precautions against the threats
you are likely to face. Balancing the need for authorized users to get access
to the system while keeping unauthorized users out is very easy to get wrong.
Fortunately, smart people have distilled the principles of security down to a
few axioms, covered very well in the first <a href="http://www.icir.org/vern/cs161-sp17/notes/Principles.1.19.pdf">lecture note</a> of CS 161
(credit to Prof. David Wagner). It is recommended to read the lecture note.</p>

<p><strong>When constructing a threat model, keep questions such as these in mind:</strong></p>
<ol>
  <li>What are you protecting?</li>
  <li>Who are your adversaries?</li>
  <li>How likely is it you will need to protect it?</li>
  <li>What are the consequences of failing to protect it?</li>
  <li>How many resources should you devote to protecting it?</li>
</ol>
      <h2 id="example-safekeeping">
        
        
          <a href="#example-safekeeping" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example: Safekeeping
        
        
      </h2>
    
<p>Let’s say that you run a safe storage facility for customers to store a variety
of valuables. <strong>Here’s a description of what your threat model might look like:</strong></p>

<p>In this scenario, you’re responsible for your clients’ valuables. There are a
multitude of adversaries, including burglars ranging from smash-and-grab to more
sophisticated attackers, disgruntled employees, clients looking to claim
fradulent loss, and natural disasters such as earthquakes, fires, or tornados.</p>

<p>Storage facilties containing potentially high amounts of valuables in close
proximity to each other may serve as enticing targets for attackers and failing
to protect the facility would result in a loss of trust that would be
devastating for a business.</p>

<p>In order to protect against burglars, an variety of protections can be enabled
from increased surveillance to 24/7 guards. The rational amount of security
depends on the level of desired profit and likelihood of a break-in.</p>

<p>Allowing clients to install their own security protects allows them protection
against both disgruntled employees and acts as a protection mechanism against
fradulent clients.</p>
      <h2 id="task-1-construct-your-own-threat-model">
        
        
          <a href="#task-1-construct-your-own-threat-model" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Task 1: Construct your own threat model
        
        
      </h2>
    
<p>You’re a journalist criticizing the local authoritarian government and trying to
get your story to ProPublica. Considering the principles of security and the 
above questions, describe your threat model and how you would safely deliver the
information.</p>
      <h1 id="security-building-blocks">
        
        
          <a href="#security-building-blocks" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Security Building Blocks
        
        
      </h1>
    
      <h2 id="encryption">
        
        
          <a href="#encryption" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Encryption
        
        
      </h2>
    
      <h3 id="a-brief-introduction">
        
        
          <a href="#a-brief-introduction" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> A Brief Introduction
        
        
      </h3>
    
<p>Hiding information from unauthorized users is a critical
element of computer security. How can you make sure we can keep this information hidden
in the case that we have to send it out into the open?</p>

<p>Here’s where the power of <strong>encryption</strong> comes in. Encryption involves taking the
information you want to hide, called the <strong>plaintext</strong>, and scrambling it into a
format that can only be read with a key called the <strong>ciphertext.</strong></p>
      <h3 id="types-of-encryption">
        
        
          <a href="#types-of-encryption" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Types of Encryption
        
        
      </h3>
    
<p>There are many different types of encryption algorithms, with different types of
encryption keys, encryption speeds, security, and usefulness. <strong>The most
important quality of encryption algorithms is the fact that they are one-way</strong>:
it is easy to compute the ciphertext from the plaintext <strong>(encrypt)</strong> but extremely
difficult to compute the plaintext from the ciphertext <strong>(decrypt)</strong> without the
secret key.</p>

<p>There are two primary types of encryption: <strong>symmetric key cryptography</strong>, and
asymmetric-key or <strong>public-key cryptography</strong>. The invention of public key
cryptography was critical to many of the security features we take for granted
today.</p>

<p>For the purpose of this lab, we will be using several tools for performing
encryption operations, among them <strong>GnuPG</strong>, a free implementation of the
<a href="https://openpgp.org/">OpenPGP</a> standard, and
<a href="https://openssl.org"><strong>OpenSSL</strong></a>, a library for implementing TLS, or
Transport Layer Security.</p>
      <h4 id="symmetric-key-cryptography">
        
        
          <a href="#symmetric-key-cryptography" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Symmetric Key Cryptography
        
        
      </h4>
    

<p>Symmetric-key cryptography is named for the fact that <strong>a single key both
encrypts and decrypts a particular plaintext to ciphertext and vice-versa</strong>. The
most widely used method of symmetric crypto is AES, or <em>Advanced Encryption
Standard</em>, which is certified and trusted by the US Government to encrypt
information critical to national security. An easy way to visualize the basics
of symmetric key crypto is by the XOR function: <code class="language-plaintext highlighter-rouge">a XOR b</code> is true if and only
if a and b are different. Suppose our plaintext is the bitstring
<code class="language-plaintext highlighter-rouge">100110100101</code>, and we want to apply a bitwise XOR with the bitstring
<code class="language-plaintext highlighter-rouge">010010100010</code>, which is our key. The result of this operation is
<code class="language-plaintext highlighter-rouge">110100000111</code>. If we XOR the resulting ciphertext with the key again, we get
the original plaintext: <code class="language-plaintext highlighter-rouge">100110100101</code>. The XOR function is trivially
reversible, but military-grade symmetric key cryptography algorithms are much
more difficult to reverse. The security of symmetric-key crypto, therefore, is
dependent on keeping the encryption key secret.</p>

<p><img src="/assets/images/labs/a9/XOR.GIF" alt="alt text" title="xor in crypto" /></p>

<p><strong>Symmetric key crypto is useful for almost everything, especially things that fall in these categories:</strong></p>
<ul>
  <li>Encrypting data in transit (such as HTTPS)</li>
  <li>Encrypting data at rest (like data stored on your phone)</li>
</ul>

<p>As an example, let’s explore how iPhones use encryption to keep your data safe:</p>
<ol>
  <li>The iPhone’s internal storage is encrypted with a set of AES keys stored on a chip inside the phone, generated at the factory.</li>
  <li>These keys are in turn encrypted with your PIN. Your PIN allows the phone to unlock the keys that allow it to decrypt the rest of the filesystem.</li>
</ol>

<p>This is how the iPhone is able to quickly wipe your data in the event your phone is
stolen: the phone simply deletes the keys that are stored on the internal chip.
Now, even with your PIN, there are no keys to decrypt and the encrypted data in
the phone’s storage is, for all intents and purposes, irretrievable and
indistinguishable from random data.</p>
      <h4 id="public-key-cryptography">
        
        
          <a href="#public-key-cryptography" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Public Key Cryptography
        
        
      </h4>
    

<p>Unlike symmetric key cryptography, there are 2 keys in a public-key
cryptosystem, the <strong>public key</strong> and the <strong>private key</strong>. As the name suggests, the
public key is shared publicly, and this is the means by which other people
encrypt data that’s meant for you. You use your private key to decrypt this
data. As long as no one has your private key, anyone can use your public key to
encrypt data and be assured that only you can decrypt it. This is a powerful
expansion on the symmetric-key paradigm, as beyond encryption, it also allows
for signatures and non-repudiation: a way for someone to verify that the person
they are talking to is in fact the person they intend to be talking to, and for
someone to prove (without the ability to deny it) that they are who they say
they are.</p>

<p>Nowadays, public-key cryptography is synonymous with the <strong><a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)">RSA algorithm</a></strong>, which
was one of the first proven dual-key schemes. (You will encounter the RSA
algorithm in CS 70 and CS 161 if you plan to take those courses, or already
have.) In short, the security of RSA depends on the theoretical difficulty of
factoring large numbers on conventional computers. This is expected to continue
to be a difficult problem until quantum computers become practical.</p>

<p>Here’s a brief overview of how RSA public key crypto works:</p>
<ol>
  <li>The RSA algorithm, by means of some advanced mathematics (involving prime numbers and modular
   arithmetic), returns 3 numbers: a public exponent (aka key), a private exponent,
   and a modulus. The two keys work such that data encrypted with one key can only
   be decrypted with the other key.</li>
  <li>In order to encrypt data, one performs modular exponentiation over the data using one of the exponents and the modulus.</li>
  <li>In order to decrypt data, one performs modular exponentation on the encrypted data
   with the partner key and modulus. In common use, one uses the larger exponent
   as the private key, which is used for decrypting data and creating signatures,
   and the smaller exponent as the public key, which is used for encryping data
   and verifying signatures.</li>
</ol>

<p>In <a href="a4#generating-and-using-ssh-keys">lab a4</a>, one task was to generate an SSH
key, using the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen -t rsa -b 4096
</code></pre></div></div>

<p>This command would generate two files, <code class="language-plaintext highlighter-rouge">~/.ssh/id_rsa</code> and <code class="language-plaintext highlighter-rouge">~/.ssh/id_rsa.pub</code>.
As the command suggests, this command generates a 4096-bit RSA key pair. You
should be able to guess which file represents the public key and which one must
therefore be the private key. In order to affect secure SSH logins using the
RSA key, the user must first transfer the public key they wish to use to
identify themselves to the server in advance. Then, once a session has been
established between the server and the client, the server will encrypt a random
number with the user’s public key and transmit it to the user. The user will
then decrypt the value using their private key and return a hash of that value
to the server, who can then hash the value themselves to determine if the user
was able to successfully decrypt the random number, thus indicating posession
of the matching secret key and serving as proof for authentication.</p>
      <h2 id="signatures-and-certificates">
        
        
          <a href="#signatures-and-certificates" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Signatures and Certificates
        
        
      </h2>
    

<p>Public key cryptography allows for a number of important security objects,
including signatures and certificates for digital identity verification.</p>

<p>Suppose you are an important public entity (maybe your pseudonym is Natoshi
Sakamoto). You are in charge of an important project, hereafter known at
Litcoin. You’d like to maintain anonymity, but still need to lead your project.</p>

<p>How can your loyal followers know that statements supposedly made by Natoshi
Sakamoto are actually from you?</p>

<p>There’s a significant incentive to make false
statements supposedly “from” Mr. Sakamoto, because each Litcoin is apparently
worth a significant amount of real money, and some people stand to gain
substantially if they are able to influence the direction of the project in
their favor.</p>

<p>You can avoid this by signing your messages: in the beginning, you
would publish Natoshi’s public key, and thereafter, for every post you make, you
would encrypt the content of the message using your (Natoshi’s) private key and
post that along with your original message. Then, anyone who wants to verify
that Natoshi (i.e. the owner of the private key corresponding to the public key
that belongs to Natoshi) did in fact publish a particular message can simply
use Natoshi’s public key to decrypt the encrypted signature and compare the
content against the original message.</p>

<p>Pretenders to Natoshi’s throne will be
unable to sign their false statements such that they can be verified with
Natoshi’s published public key because they don’t have Natoshi’s private key,
and you can rest assured that no one will unduly influence your project in your
name while you go into hiding from the IRS and DEA, unless they happen to have
warehouses full of ASICs and lots of cheap electricity.</p>

<p><strong>However, in this scheme, how do you prevent an adversary from publishing a fake
public key and claiming to be you?</strong> (they can make valid signatures against that
fake public key) Somehow, you need to “bootstrap” trust: someone would need to
verify your identity and publicly affirm that your public key actually
corresponds to you.</p>

<p>We do this by means of <strong>certificates</strong>: a signed statement
claiming that a particular public key does, in fact, belong to who it claims to
belong to.</p>

<p>Who signs this certificate? A <strong>certificate authority</strong>, someone we
trust to be responsible about verifying identities and issuing signatures.</p>

<p>But how do we know which CAs to trust, and how can we trust that a CA that claims
to be trustworthy actually is? They probably need a certificate as well. It
sounds like it might be turtles all the way down; however, the chain does end
somewhere: the so-called root of trust, the root CAs. These are the CAs whose
certificates are pre-installed by browsers and operating systems and therefore
intrinsically trusted, without any further certificates necessary. If a root CA
signs your certificate, we assume they’ve done the due diligence necessary to
be willing to risk their reputation by signing your certificate, and basically
take their word for it. This model, known as the <strong>Web of Trust</strong>, is how network
security works today.</p>

<p>Unfortunately, it isn’t as reliable as we may have hoped:
some CAs are scummy and will sign anything for enough money, resulting in valid
certificates being issued for domains like microsoft.com and github.com to
entities who are very obviously not Microsoft or GitHub.<sup id="fnref:badwosign" role="doc-noteref"><a href="#fn:badwosign" class="footnote" rel="footnote">1</a></sup> Furthermore,
any entity with enough border control can force the installation of their own
root certificates (e.g. the government of Kazakhstan<sup id="fnref:badkazakh" role="doc-noteref"><a href="#fn:badkazakh" class="footnote" rel="footnote">2</a></sup>) and intercept
any traffic by issuing their own bogus certificates for any domain.</p>

<p><img src="/assets/images/labs/a9/certificate.png" alt="OCF has https" /></p>

<p>You might not realize it, but <strong>you use and rely on certificates and signatures
every day.</strong> Any time you see a green lock near the address bar of a website you
visit, you are accesssing the site over a TLS or HTTPS connection, and the data
being transferred between you and the website is encrypted. When your browser
connects to the website’s server, it asks for the server’s public key in order
to set up an encrypted connection, and the server’s certificate in order to
verify its identity as the server authorized to serve the domain you have
requested. Your browser then validates the public key by verifiying the
signatures on the certificate. If someone is attempting to perform a
man-in-the-middle attack on you, this certificate verification step will fail,
because it should be unlikely that a trusted CA will have issued a signed cert
for your domain to an entity other than you (unless you have the misfortune of
living in Kazakhstan). You will get a very intrusive notification informing you
of this fact, and it is a bad idea to ignore the certificate verification
failure notification.</p>
      <h2 id="hashing">
        
        
          <a href="#hashing" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hashing
        
        
      </h2>
    

<p>There are many times where we have large amounts of data but need to operate on
smaller representations of that data. For example, suppose you download a 1GB
file from the internet. You want to make sure that the file you downloaded has
not been modified on its way to you (after having taken the DeCal, you know
that integrity is a critical goal of computer security). How could you figure
out if the file has been changed? You could try downloading another copy to see
if there’s a difference, but both copies could have been modified, and it takes
a long time to download 1GB. You could use your knowledge of signatures to see
if the source has provided a signature of the file you could verify, but the
signature would have to be over the whole file<sup id="fnref:pkcsize" role="doc-noteref"><a href="#fn:pkcsize" class="footnote" rel="footnote">3</a></sup> and this is even more
expensive. What we really need is a deterministic way to generate fixed-length
representations of arbitrary-length data. Luckily, mathematics has our back
with functions known as hash functions. If you took CS 61B, you probably
implemented a hash table at some point, and may be familiar with the concept.
Here’s an example of hash functions at work. Enter the following commands on
your student VM (i.e. <code class="language-plaintext highlighter-rouge">ssh username.decal.xcf.sh</code>) to calculate the SHA1<sup id="fnref:sha1" role="doc-noteref"><a href="#fn:sha1" class="footnote" rel="footnote">4</a></sup>
hash of a 40MB file.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">wget https://raw.githubusercontent.com/0xcf/decal-labs/master/a9/lab9.jpg</code></li>
  <li><code class="language-plaintext highlighter-rouge">sha1sum lab9.jpg</code></li>
</ol>

<p>You should see <code class="language-plaintext highlighter-rouge">685e925838358fdc162935588c6ee0aa5a5caed6</code>, a 40-digit string.
As you can imagine, transferring this string is much easier than transferring a
large, 100MB file, and because of the properties of the SHA-1 algorithm, you
can be reasonably sure that this file, and only this file, will always hash to
that particular value. This means, if you want to verify that the file you
downloaded hasn’t been corrupted, you can simply compare the hashes (or more
specifically, a signature over the hash) to ensure that the file you’ve
downloaded hasn’t been tampered with.</p>
      <h1 id="encryption-lab-activity">
        
        
          <a href="#encryption-lab-activity" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Encryption Lab Activity
        
        
      </h1>
    

<p>In this lab, we will be exploring the topics covered so far: symmetric
encryption and public key cryptography, hashing, signatures, and certificates.
Please make sure you are logged into the appropriate server over ssh prior to
completing any of the following tasks.</p>
      <h3 id="submission">
        
        
          <a href="#submission" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Submission
        
        
      </h3>
    

<p>Remember to submit your answers to Gradescope as you complete the lab!</p>
      <h3 id="introduction-making-ssh-keys">
        
        
          <a href="#introduction-making-ssh-keys" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction: Making SSH keys
        
        
      </h3>
    

<p>We’ll begin our exploration of security building blocks by creating SSH
keypairs for ourselves, in case you haven’t already. If you already have an SSH
key on your personal computer that you would like to continue to use, or one on
<code class="language-plaintext highlighter-rouge">tsunami</code>, feel free to skip these steps and proceed to task 1, but please make
sure that you can use that key to log into your student VM.</p>

<p>As mentioned earlier in this document, and in
<a href="a4#generating-and-using-ssh-keys">lab a4</a>, here is how to create a 4096-bit
RSA SSH keypair:</p>

<ol>
  <li>Log into <code class="language-plaintext highlighter-rouge">tsunami.ocf.berkeley.edu</code> with your OCF account credentials
(potentially not the same as your decal VM credentials). It is important you
do these steps on <code class="language-plaintext highlighter-rouge">tsunami</code> and not your laptop, an OCF desktop, or your
decal VM.</li>
  <li>Check to make sure you do not have an existing SSH key:
    <ol>
      <li>Enter <code class="language-plaintext highlighter-rouge">ls -l ~/.ssh</code></li>
      <li>If you see files like <code class="language-plaintext highlighter-rouge">id_rsa</code> or <code class="language-plaintext highlighter-rouge">id_rsa.pub</code> then you already have an
SSH key.</li>
    </ol>
  </li>
  <li>If no key is present, create a new key now by typing <code class="language-plaintext highlighter-rouge">ssh-keygen -t rsa -b
4096</code>, and hit enter when prompted.</li>
  <li>If you are asked to type a password to protect the key, you may choose to
enter one, but for the purpose of this lab, it is advisable to skip doing
so.</li>
</ol>

<p>You should now see two new files in the <code class="language-plaintext highlighter-rouge">~/.ssh/</code> directory. <code class="language-plaintext highlighter-rouge">id_rsa</code> is your
SSH private key, and it should like the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat ~/.ssh/id_rsa
-----BEGIN RSA PRIVATE KEY-----
&lt;random characters&gt;
-----END RSA PRIVATE KEY------
</code></pre></div></div>

<p>Please try to not lose or leak this private key. The public key, <code class="language-plaintext highlighter-rouge">id_rsa.pub</code>,
should be much shorter and look like the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat ~/.ssh/id_rsa.pub
ssh-rsa &lt;characters&gt; &lt;username&gt;@&lt;host&gt;
</code></pre></div></div>

<p>It is safe to transfer your RSA public key out in the open, whereas you should
never do so with your private key. It should only be transferred over trusted
and encrypted communication channels over machines you trust.</p>

<p>You’ve just created for yourself an RSA keypair suitable for SSH authentication.</p>

<p>For the remaining tasks in this lab, you will be tasked with figuring out the
appropriate commands yourself, by Googling, reading man pages, etc. Hints will
be given as footnotes as necessary. Please document the commands you use and be
prepared to provide a rationale for why you believe those commands are correct.</p>
      <h3 id="warm-up-task">
        
        
          <a href="#warm-up-task" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Warm-up Task
        
        
      </h3>
    

<p>Figure out how to use the SSH key you’ve created to log into your student
VM.<sup id="fnref:ssh-copy-id" role="doc-noteref"><a href="#fn:ssh-copy-id" class="footnote" rel="footnote">5</a></sup></p>

<p><strong>Perform the remaining tasks on your student VM unless otherwise specified.</strong></p>
      <h3 id="task-2---symmetric-encryption">
        
        
          <a href="#task-2---symmetric-encryption" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Task 2 - Symmetric Encryption
        
        
      </h3>
    

<p>In order to explore encryption, we’re going to be using the <code class="language-plaintext highlighter-rouge">gpg</code> command.</p>

<ol>
  <li>
    <p>Download<sup id="fnref:wget" role="doc-noteref"><a href="#fn:wget" class="footnote" rel="footnote">6</a></sup> the file named <code class="language-plaintext highlighter-rouge">q2.txt.gpg</code> from
<a href="https://raw.githubusercontent.com/0xcf/decal-labs/master/a9/q2.txt.gpg">github</a>,
decrypt it using <code class="language-plaintext highlighter-rouge">gpg</code> and the password <code class="language-plaintext highlighter-rouge">weak_password</code>. <strong>What is the 
decrypted content?</strong></p>
  </li>
  <li>
    <p>Create a text file with your full name, username, and some random content in
it. Then, use <code class="language-plaintext highlighter-rouge">gpg</code> to symmetrically encrypt this text file using the
TWOFISH algorithm and a password of your choice. Make sure the resulting
encrypted file is in ASCII-armored format<sup id="fnref:armor" role="doc-noteref"><a href="#fn:armor" class="footnote" rel="footnote">7</a></sup>.</p>

    <p><strong>What command did you use to do this?</strong></p>

    <!-- Figure out how to
distribute this encrypted file to someone else in the lab, and have
them demonstrate their ability to decrypt the file with your chosen
passphrase. Get one such file from someone else yourself and do the
same.[^extracredit] -->
  </li>
</ol>
      <h3 id="task-3---asymmetric-encryption">
        
        
          <a href="#task-3---asymmetric-encryption" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Task 3 - Asymmetric Encryption
        
        
      </h3>
    

<p>Remember to perform all the following steps on your student VM.</p>

<p>In this task, we will be using <code class="language-plaintext highlighter-rouge">gpg</code> to create a PGP key.</p>

<p>Step 0: Figure out how to do make this key<sup id="fnref:ghgpg" role="doc-noteref"><a href="#fn:ghgpg" class="footnote" rel="footnote">8</a></sup>, and create a 4096-bit
RSA/RSA PGP key.</p>

<p>You might be wondering: didn’t we just create a 4096-bit RSA key for use in
SSH? Why can’t we just use the same key for GPG? The short answer is that,
while technically possible, it is
<a href="https://serverfault.com/questions/346958/how-do-i-import-a-rsa-ssh-key-into-gpg-as-the-primary-private-key">inadvisable</a>
to do so for security reasons.</p>

<ol>
  <li>
    <p>After creating the key, retrieve the key ID and put it in the checkoff form.</p>
  </li>
  <li>
    <p>Export the public portion of the key in ASCII armor format and figure out
how to distribute it. For every subsequent step, make sure to do everything
using ASCII armored output where applicable.</p>
  </li>
  <li>
    <p>The DeCal staff have a <a href="https://raw.githubusercontent.com/0xcf/decal-labs/master/a9/staff_public_key.gpg">public key
available</a>.
Figure out how to import the key, and write down the key id.</p>
  </li>
  <li>
    <p>The DeCal staff have uploaded a few
<a href="https://github.com/0xcf/decal-labs/tree/master/a9">files</a> called directions to help you
figure out how to get to the OCF. However, we suspect nefarious elements may
be trying to modify the file in an effort to divert students to their
location. Figure out if the file has been modified. (<strong>Hint:</strong> Check the signature!)</p>
  </li>
  <li>
    <p>Where is your private key located? Write down the location where you expect
the private key to be.</p>
  </li>
</ol>

<p>We will return to encryption later in the lab.</p>
      <h3 id="task-4---hashing">
        
        
          <a href="#task-4---hashing" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Task 4 - Hashing
        
        
      </h3>
    

<p>Fortunately all the common hashing algorithms have been implemented for us by
various libraries. For this lab, please compute the requested hashes by any
method you deem appropriate. It would be advisable to do these on an OCF
desktop, or on your student VMs, but <em>not</em> on tsunami, because this leaves
around a large file that takes up extra space if not cleaned up.</p>

<ol>
  <li>
    <p>Download a copy of the CentOS 7 NetInstall ISO from the <a href="http://mirrors.ocf.berkeley.edu/centos/7/isos/x86_64/">OCF
mirrors</a> and verify
that its SHA256 hash is correct. Also compute its SHA1 and MD5 hashes.</p>
  </li>
  <li>
    <p>You may have noticed that the CentOS project provides a signature over the
hashes it provides (the .asc file in the same directory as above). Briefly
explain why this is a good, efficient security measure, knowing what you do
about how signatures, hashing, and malicious attempts at file corruption
work.</p>
  </li>
</ol>
      <h2 id="file-security">
        
        
          <a href="#file-security" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> File Security
        
        
      </h2>
    

<p>Now that you have some experience with the primitives of encryption, let’s
cover some practical topics in securing files on UNIX-based systems.</p>
      <h3 id="file-security-and-permissions">
        
        
          <a href="#file-security-and-permissions" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> File Security and Permissions
        
        
      </h3>
    

<p>The base layer in the UNIX security hierarchy is file permissions. Every file
and process is owned by a user (and group), and by default, only the user/group
that owns the file can edit it. You can see this by typing <code class="language-plaintext highlighter-rouge">ls -la</code> in your
terminal:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@staff:~$ ls -la
total 104
drwxr-xr-x 9 admin admin  4096 Oct  3 13:01 .
drwxr-xr-x 5 root  root   4096 Oct  2 16:49 ..
drwxr-xr-x 2 admin admin  4096 Sep 21 21:11 .augeas
-rw------- 1 admin admin 27932 Oct  6 14:05 .bash_history
-rw-r--r-- 1 admin admin   220 May 15 12:45 .bash_logout
-rw-r--r-- 1 admin admin  3526 May 15 12:45 .bashrc
drwx------ 3 admin admin  4096 Sep 17 12:02 .config
drwxr-xr-x 4 admin admin  4096 Oct  3 12:47 .gem
drwxr-xr-x 2 admin admin  4096 Oct  3 12:46 .nano
-rw-r--r-- 1 admin admin   675 May 15 12:45 .profile
drwxr-xr-x 4 admin admin  4096 Sep 17 14:23 .puppet
drwx------ 2 admin admin  4096 Sep 17 12:09 .ssh
drwxr-xr-x 3 admin admin  4096 Oct  3 12:38 test
-rw------- 1 admin admin 21980 Oct  2 16:42 .viminfo
</code></pre></div></div>

<p>The first column, e.g. <code class="language-plaintext highlighter-rouge">-rw-------</code>, is the read/write/execute permissions for
the file. The third and fourth columns are the user and group that own the file.</p>

<p>Let’s break down the permissions seen in the example above. You’ll notice that
there are 10 entries: they either start with <code class="language-plaintext highlighter-rouge">d</code> for directory or <code class="language-plaintext highlighter-rouge">-</code> for
regular files<sup id="fnref:firstpermflag" role="doc-noteref"><a href="#fn:firstpermflag" class="footnote" rel="footnote">9</a></sup>, the the remaining 9 entries are split into 3
groups of 3 permission each: <code class="language-plaintext highlighter-rouge">r</code>ead, <code class="language-plaintext highlighter-rouge">w</code>rite, and e<code class="language-plaintext highlighter-rouge">x</code>ecute for <code class="language-plaintext highlighter-rouge">u</code>user,
<code class="language-plaintext highlighter-rouge">g</code>roup, and <code class="language-plaintext highlighter-rouge">o</code>ther. That means <code class="language-plaintext highlighter-rouge">-rw-------</code> refers to a regular file, where
the owner can read and write but not execute the file, and no one else can
either read, write, nor execute the file. On the other hand, the permissions
on the <code class="language-plaintext highlighter-rouge">test</code> entry (<code class="language-plaintext highlighter-rouge">drwxr-xr-x</code>) indicate that it is a directory, everyone
can enter the directory (<code class="language-plaintext highlighter-rouge">d--x--x--x</code>), anyone can list files inside the
directory (<code class="language-plaintext highlighter-rouge">dr--r--r--</code>), but only the owning user can write files inside the
directory (<code class="language-plaintext highlighter-rouge">d-w-------</code>). A key point to remember is the difference between
execute permissions on files vs. directories: on directories, it refers to the
ability to enter the directory.</p>

<p><img src="https://www.comentum.com/images/permissions.jpg" alt="alt test" /></p>

<p>The kernel enforces file permissions, preventing running programs from reading
or modifying files they aren’t allowed to, and preventing users from executing
programs that they don’t have access or permission for. This is important for a
variety of reasons. For example, certain UNIX user accounts have their
account information stored in a file called <code class="language-plaintext highlighter-rouge">/etc/passwd</code> and password hashes
in <code class="language-plaintext highlighter-rouge">/etc/shadow</code>. These files are owned by <code class="language-plaintext highlighter-rouge">root</code>, preventing regular users
from reading or changing this information without permission.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ls -la /etc/shadow
-rw------- 1 root root 861 Oct  9 02:22 /etc/shadow
</code></pre></div></div>

<p>This highlights a common security issue in UNIX: programs running as the <code class="language-plaintext highlighter-rouge">root</code>
user. When a program is started, it inherits its user and group IDs from its
parent process, and keeps them unless it manually drops permissions. If you
start a program as the root user, because, for example, it requires deeper
system access, a vulnerability in the program means that an attacker can
interact with your computer as the root user. This is a common problem in
misconfigured webservers, where a server running as root with a directory
traversal vulnerability might allow an attacker to read secret credentials
stored on the server’s filesystem.</p>

<p>The moral of this story is tied to the principle of least privilege: wherever
possible, only give the minimum amount of permission or privilege possible. If
a program doesn’t need root credentials, don’t run it as a privileged user. If
a file has sensitive content, don’t make it world-readable.</p>

<p>How do you change permissions? There are two primary commands for doing so:
<code class="language-plaintext highlighter-rouge">chmod</code> and <code class="language-plaintext highlighter-rouge">chown</code>. <code class="language-plaintext highlighter-rouge">chmod</code> changes the file mode, i.e. permissions, and an
example of its syntax follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -la ~/
drwxr-xr-x 3 admin admin  4096 Oct  3 12:38 test
$ chmod 644 test
$ ls -la
drw-r--r-- 3 admin admin  4096 Oct  3 12:38 test
$ chmod u+x test
drwxr--r-- 3 admin admin  4096 Oct  3 12:38 test
$ chmod 000 test
d--------- 3 admin admin  4096 Oct  3 12:38 test
$ chmod +r test
dr--r--r-- 3 admin admin  4096 Oct  3 12:38 test
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">chmod</code> accepts file permissions in octal notation, which is the
following:</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>#</th>
      <th>rwx</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>7</td>
      <td>rwx</td>
    </tr>
    <tr>
      <td>6</td>
      <td>rw-</td>
    </tr>
    <tr>
      <td>5</td>
      <td>r-x</td>
    </tr>
    <tr>
      <td>4</td>
      <td>r–</td>
    </tr>
    <tr>
      <td>3</td>
      <td>-wx</td>
    </tr>
    <tr>
      <td>2</td>
      <td>-w-</td>
    </tr>
    <tr>
      <td>1</td>
      <td>–x</td>
    </tr>
    <tr>
      <td>0</td>
      <td>—</td>
    </tr>
  </tbody>
</table></div>

<p><code class="language-plaintext highlighter-rouge">chown</code> on the other hand changes the owner and group of a file. For example,
suppose a file <code class="language-plaintext highlighter-rouge">instructions.txt</code> is created in your home directory (<code class="language-plaintext highlighter-rouge">~you</code>) by
user <code class="language-plaintext highlighter-rouge">staff</code> with permissions <code class="language-plaintext highlighter-rouge">-rw-------</code>. You need to read this file to
follow the instructions, but the <code class="language-plaintext highlighter-rouge">staff</code> user did not make the file
world-readable so you could open it. In order to read it, you may first want to
<code class="language-plaintext highlighter-rouge">chown</code> the file to yourself, by running <code class="language-plaintext highlighter-rouge">chown you:you instructions.txt</code>. This
would change the file’s owner and owning group, previously “staff” and “staff”,
to you. The basic syntax of <code class="language-plaintext highlighter-rouge">chown</code> is fairly simple:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chown [-R] [user]:[group] PATH
</code></pre></div></div>

<p>where <code class="language-plaintext highlighter-rouge">PATH</code> is the file or directory whose ownership you wish to modify, and <code class="language-plaintext highlighter-rouge">-R</code>
means ‘recursive.’</p>

<p>Making sure that files are only accessible to those who should be allowed to do
so, and that vulnerable programs are not given too many permissions, is a
critical part of maintaining system security on Linux.</p>
      <h3 id="task-5---file-security">
        
        
          <a href="#task-5---file-security" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Task 5 - File Security
        
        
      </h3>
    

<!-- These files are currently all in puppet ugh --->
<!-- https://github.com/0xcf/decal-puppet/blob/master/modules/decal_student/manifests/labs/lab8.pp --->

<p>Lets practice using the commands and concepts covered above.</p>

<!-- 

`cd` into the folder `/opt/a8` on your student VM. You should see a number of
files named `file1.txt` through `file9.txt`. Please answer the following
questions with regards to each of the files, and make note of what commands you
use for checkoff.

1. `file1.txt`: make this file readable using `chmod` and answer the question
   contained therein.
2. `file2.txt`: if you read this file, you'll notice it contains important
   decal secrets. Use `chmod` and `chown` to make the file readable only to
   you.
3. `file3.txt`: this is an even more important file. Only root should be able
   to read this file, and no one should be able to edit it.
4. `file4.txt` and `file5.txt`: these files are owned by another user. Choose
   any method to make the files readable to you and unreadable to the previous
   owner.
5. `file6.txt` and `file7.txt`: look at the permissions for these two files and
   explain what they allow and disallow.
6. `file8.txt` and `file9.txt`: provide a strategy to make these files readable
   only to you and the `a8user` user, and no one else.

-->

<p>Please answer the following questions with regards to some arbitary files, and
make note of what commands you would use for checkoff. It’s recommended to play
around with those commands on your own.</p>

<p>Let’s say you have a file:</p>

<ol>
  <li>How would you make that file readable to you?</li>
  <li>What if the file is very important, as it contains decal secrets. Use <code class="language-plaintext highlighter-rouge">chmod</code>
and <code class="language-plaintext highlighter-rouge">chown</code> to make the file readable only to you.</li>
  <li>Lets say we have an even more important file. Only root should be able
to read this file, and no one should be able to edit it.</li>
  <li>Lets say <code class="language-plaintext highlighter-rouge">file4.txt</code> and <code class="language-plaintext highlighter-rouge">file5.txt</code> are files are owned by another user. Choose
any method to make the files readable to you and unreadable to the previous
owner.</li>
  <li>Lets say we have two files, <code class="language-plaintext highlighter-rouge">filea.txt</code> and <code class="language-plaintext highlighter-rouge">fileb.txt</code>: provide a strategy
to make these files readable only to you and the <code class="language-plaintext highlighter-rouge">decal</code> user, and no one else.</li>
</ol>
      <h2 id="network-security">
        
        
          <a href="#network-security" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Network Security
        
        
      </h2>
    

<p>On UNIX based operating systems, the network is the most common method of
gaining unauthorized access to a machine. Why this is the case should be
obvious: the network allows one to interact with a machine without needing any
physical presence. Anyone on the same network as your machine can connect, and
therefore attack, your machine. On the internet, this means the whole world can
attack your machine. This introduces a number of security considerations when
running networked applications.</p>

<p>The first step in securing machines connected to a network, or the open
internet, is to make it as hard as possible for attackers to get to your
machine. As you may recall from the networking lecture, processes interact with
one another over a network by means of sockets and ports. Many protocols listen
on well-known ports, such as SSH on port 22, HTTP on port 80, FTP on port 21,
etc. We use firewalls and similar software to prevent unauthorized users from
connecting to your machine.</p>

<p>The second step in maintaining network security is to audit which programs are
running on your server, and to design your network to reduce the attack vectors
on any single machine by separating concerns as much as reasonably possible.
For example, it may not be a good idea to run a critical database server and a
potentially insecure webserver on the same machine, as a vulnerability in one
could easily lead to the compromising of the other. At the very least, all these
programs should be run as minimally privileged users, and never as <code class="language-plaintext highlighter-rouge">root</code> unless
necessary, like <code class="language-plaintext highlighter-rouge">sshd</code>.</p>

<p>Finally, the hardest part of online security is auditing your own code.
Ultimately, most security vulnerabilities arise from code you need to run to
affect your business functions. For example, the popular CMS software
WordPress, which is estimated to power nearly a quarter of all websites, has
historically been extremely vulnerable to security bugs, especially because people
like to install WordPress plugins, often written by amateur coders, which are even
less secure. Unfortunately, the only real defense against one’s own imperfection
as a programmer is to be vigilant about monitoring one’s programs for vulnerabilities
and servers for intrusion, and following good defensive programming practices on the
road towards the impossible goal of secure, bug-free programs.</p>
      <h3 id="task-6---network-security-lab-activity">
        
        
          <a href="#task-6---network-security-lab-activity" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Task 6 - Network Security Lab Activity
        
        
      </h3>
    

<ol>
  <li>
    <p>Make a list of all the services running on your student VM that are
accessible from the public internet, what user they are running as, and what
port they are listening on. You may find tools such
as <code class="language-plaintext highlighter-rouge">netstat</code> and <code class="language-plaintext highlighter-rouge">ps</code> to be helpful. You may also want to point <code class="language-plaintext highlighter-rouge">nmap
-A</code> at your VM from another machine, such as <code class="language-plaintext highlighter-rouge">tsunami</code>.</p>
  </li>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">less</code> and <code class="language-plaintext highlighter-rouge">grep</code> to open up and search your SSH login log file, located
in <code class="language-plaintext highlighter-rouge">/var/log/auth.log</code>. Besides yourself, is anyone trying to log in? Who
and why if there is?</p>
  </li>
</ol><hr />
      <h2 id="optional-task-letsencrypt-on-an-nginx-instance">
        
        
          <a href="#optional-task-letsencrypt-on-an-nginx-instance" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Optional Task: Letsencrypt on an nginx instance!
        
        
      </h2>
    

<p><strong>This task is somewhat involved and completely optional.</strong> With that said,
being able to use <code class="language-plaintext highlighter-rouge">certbot</code> to provision certificates is an invaluable skill that
you will likely need when setting up your own webservers. If you ever need to do this
in the future, you know where to find a guide! :)</p>

<p>In this task, we’re going to set up one of the most common uses of certificates
and signatures: HTTPS. As you might have realized, you are now in possession of
a website and webserver, (&lt;you&gt;.decal.xcf.sh), at least for the time
being. Perform the following tasks on your student VM.</p>

<p>Suppose you want to start hosting files on your site for other people to visit
and see.</p>

<p>First, install the <code class="language-plaintext highlighter-rouge">nginx</code> package to get a web server, and then customize the
file at <code class="language-plaintext highlighter-rouge">/var/www/html/index.html</code> to reflect your indiviuality. You can see
this new file at <code class="language-plaintext highlighter-rouge">&lt;you&gt;.decal.xcf.sh</code> in a web browser.</p>

<p>Now that you have a website, you decide that, as a good internet citizen, you
want to protect your visitors from the prying eyes of the government, by
setting up HTTPS. You know already that you will need a public key and a
certificate signed by a trusted root CA in order to do this. How do you go
about getting one? Searching the internet, you find a wonderful project called
<a href="https://letsencrypt.org">Let’s Encrypt</a> that provides free, signed
certificates. Let’s go about acquiring one.</p>

<p>For the purpose of this lab, we will be performing all the required steps
manually instead of using the automated tools for educational purposes.</p>

<ol>
  <li>
    <p>The first step in acquiring a signed certificate is to generate the public
and private key that the certificate will validate. We can do so by using
the <code class="language-plaintext highlighter-rouge">openssl</code> command.</p>

    <p><code class="language-plaintext highlighter-rouge">$ openssl genrsa 4096 &gt; domain.key</code></p>

    <p>As you probably guessed, we just created another 4096-bit RSA keypair, this
 time, in PEM format. Both the public and private keys are encoded in the
 file <code class="language-plaintext highlighter-rouge">domain.key</code>, which you can see using <code class="language-plaintext highlighter-rouge">cat</code>.</p>
  </li>
  <li>
    <p>For Let’s Encrypt, we’ll also need an another key for our Lets Encrypt
account. Repeat the command from above, but this time, output to a file
called <code class="language-plaintext highlighter-rouge">account.key</code>.<sup id="fnref:account-key" role="doc-noteref"><a href="#fn:account-key" class="footnote" rel="footnote">10</a></sup> Let’s also export the public portion of
this key as you’ll need it soon when you authenticate to LetsEncrypt.</p>

    <p><code class="language-plaintext highlighter-rouge">$ openssl rsa -in account.key -pubout &gt; account.pub</code></p>
  </li>
  <li>
    <p>Now that we have a keypair that we want signed, (<code class="language-plaintext highlighter-rouge">domain.key</code>), let’s
generate a “Certificate Signing Request” for it. This will be what you send
to Let’s Encrypt in order to get a certificate for your public key. It
contains the metadata necessary for LE to issue a certificate.</p>

    <p><code class="language-plaintext highlighter-rouge">$ openssl req -new -sha256 -key domain.key -subj "/C=US/ST=CA/L=UC
 Berkeley/O=Open Computing
 Facility/emailAddress=&lt;you&gt;@ocf.berkeley.edu/CN=&lt;you&gt;.decal.xcf.sh" -out
 csr.pem -outform pem</code></p>

    <p>You’ll find a file in your directory called <code class="language-plaintext highlighter-rouge">csr.pem</code> that starts with
 <code class="language-plaintext highlighter-rouge">BEGIN CERTIFICATE REQUEST</code>. What did you just do? You asked for a <code class="language-plaintext highlighter-rouge">-new</code>
 certificate signing <code class="language-plaintext highlighter-rouge">req</code>uest for the public <code class="language-plaintext highlighter-rouge">-key</code> in <code class="language-plaintext highlighter-rouge">domain.key</code>, using
 <code class="language-plaintext highlighter-rouge">-sha256</code> for hashing. You are &lt;you&gt;@something from the OCF at UC
 Berkeley, CA, US, and you’re making this request for the domain name (aka
 <code class="language-plaintext highlighter-rouge">C</code>ommon <code class="language-plaintext highlighter-rouge">N</code>ame) &lt;you&gt;.decal.xcf.sh. You’d also like the CSR to be in
 <code class="language-plaintext highlighter-rouge">pem</code> format.</p>

    <p>Now, we have all the data we need to actually get a certificate. Let’s
 submit the request to Let’s Encrypt.</p>
  </li>
  <li>
    <p>Install the <code class="language-plaintext highlighter-rouge">certbot</code> utility and do the following:</p>

    <p>Enter the following command at a terminal:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> sudo certbot certonly \
      --authenticator manual \
      --text \
      --email &lt;you&gt;@email.address \
      --csr csr.pem
</code></pre></div>    </div>

    <p>You will be asked to answer some questions, read them and type “Y” when
 prompted. On the last prompt, you will be asked to make a file available in the
 root directory of the web server, either by copying the file yourself or by
 executing the Python code provided by the <code class="language-plaintext highlighter-rouge">certbot</code> program. It is recommended
 to use the Python code in a new terminal window. Here is what the code should
 look like: (<em>do not copy and paste this</em>, use the code provided by <code class="language-plaintext highlighter-rouge">certbot</code>)</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> # mkdir -p /tmp/certbot/public_html/.well-known/acme-challenge
 # cd /tmp/certbot/public_html
 # printf "%s" &lt;random&gt; &gt; .well-known/acme-challenge/&lt;random&gt;
   # run only once per server:
 # sudo $(command -v python2 || command -v python2.7 || command -v python2.6) -c \
    "import BaseHTTPServer, SimpleHTTPServer; \
    s = BaseHTTPServer.HTTPServer(('', 80), SimpleHTTPServer.SimpleHTTPRequestHandler); \
    s.serve_forever()"
</code></pre></div>    </div>

    <p>After this, the <code class="language-plaintext highlighter-rouge">certbot</code> client will verify that the domain is legit and issue
 a certificate, writing it to your current directory, likely as
 <code class="language-plaintext highlighter-rouge">0000_chain.pem</code>.</p>

    <p>This <code class="language-plaintext highlighter-rouge">.pem</code> file is your signed certificate! Once you set it up with a web
 server, people will be able to securely browse your website.</p>

    <p>Let’s configure the webserver to use your new certificate to secure requests.</p>
  </li>
  <li>
    <p>Make sure that <code class="language-plaintext highlighter-rouge">nginx</code> is installed, otherwise you won’t be able to view
your website.</p>

    <p><code class="language-plaintext highlighter-rouge">nginx</code> stores its configuration information in <code class="language-plaintext highlighter-rouge">/etc/nginx</code>.
From the <a href="https://github.com/0xcf/decal-labs/">decal-labs</a> repository,
add the file <code class="language-plaintext highlighter-rouge">a9/nginx-a9.conf</code> to the <code class="language-plaintext highlighter-rouge">/etc/nginx/sites-enabled/</code>
directory.</p>
  </li>
  <li>
    <p>Edit <code class="language-plaintext highlighter-rouge">nginx-a9.conf</code> using your preferred text editor and fix it according
to the instructions contained therein.</p>
  </li>
  <li>
    <p>Rename <code class="language-plaintext highlighter-rouge">nginx-lab9.conf</code> to <code class="language-plaintext highlighter-rouge">default</code> and reload nginx.<sup id="fnref:reloadnginx" role="doc-noteref"><a href="#fn:reloadnginx" class="footnote" rel="footnote">11</a></sup></p>
  </li>
</ol>

<p>Now, if you visit <code class="language-plaintext highlighter-rouge">https://&lt;you&gt;.decal.xcf.sh</code>, you should see the green lock
in the address bar indicating that your website is secured with HTTPS!</p>
      <h1 id="footnotes">
        
        
          <a href="#footnotes" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Footnotes
        
        
      </h1>
    

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:badwosign" role="doc-endnote">
      <p>https://thehackernews.com/2016/08/github-ssl-certificate.html <a href="#fnref:badwosign" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:badkazakh" role="doc-endnote">
      <p>https://news.ycombinator.com/item?id=10663843 <a href="#fnref:badkazakh" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:pkcsize" role="doc-endnote">
      <p>limitations on the size of data that public key crypto can operate over render this option nontrivial and difficult to implement. <a href="#fnref:pkcsize" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:sha1" role="doc-endnote">
      <p>https://en.wikipedia.org/wiki/SHA1 <a href="#fnref:sha1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:ssh-copy-id" role="doc-endnote">
      <p>hint: look at the man page <code class="language-plaintext highlighter-rouge">ssh-copy-id</code> command. <a href="#fnref:ssh-copy-id" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:wget" role="doc-endnote">
      <p>use of wget is recommended <a href="#fnref:wget" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:armor" role="doc-endnote">
      <p>see the <code class="language-plaintext highlighter-rouge">--armor</code> option <a href="#fnref:armor" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:ghgpg" role="doc-endnote">
      <p>GitHub has <a href="https://help.github.com/articles/generating-a-new-gpg-key/">excellent documentation</a> on creating all kinds of cryptographic keys. <a href="#fnref:ghgpg" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:firstpermflag" role="doc-endnote">
      <p>There are others too, like ‘l’ for symbolic link <a href="#fnref:firstpermflag" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:account-key" role="doc-endnote">
      <p><code class="language-plaintext highlighter-rouge">$ openssl genrsa 4096 &gt; account.key</code> <a href="#fnref:account-key" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:reloadnginx" role="doc-endnote">
      <p>recall lab 6: <code class="language-plaintext highlighter-rouge">systemctl reload nginx</code> <a href="#fnref:reloadnginx" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        
        <hr>
        <footer>
  <div class="col-lg-12 text-center">
    <p>
      <a href="https://www.digitalocean.com" class="no-underline">
        <img
          src="/assets/images/digitalocean.png"
          style="height: 34px; width: 200px"
      /></a>
      <span>
        With great appreciation to
        <a href="https://www.digitalocean.com">DigitalOcean</a> for sponsoring
        the VMs used in both tracks of the DeCal
      </span>
    </p>
    <p>
      <a href="https://www.linode.com" class="no-underline">
        <img
          src="/assets/images/linode.png"
          style="height: 50px; width: 125px"
        />
      </a>
      <span>
        Huge thanks to
        <a href="https://www.linode.com">Linode</a> for sponsoring the equipment
        used to record digital lectures for the Decal
      </span>
    </p>
    <p>
      <a href="https://www.ocf.berkeley.edu" class="no-underline">
        <img
          src="https://www.ocf.berkeley.edu/hosting-logos/ocf-hosted-penguin.svg"
          alt="Hosted by the OCF"
          style="border: 0"
      /></a>
      <span>
        Copyright &copy; 2017-2021
        <a href="https://www.ocf.berkeley.edu"> Open Computing Facility </a>
        and
        <a href="https://xcf.berkeley.edu"> eXperimental Computing Facility </a>
      </span>
    </p>
    <p>
      <span>
        This website and its course materials are licensed under the terms of the
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
          CC BY-NC-SA 4.0
        </a>
        License.
        <a href="https://github.com/0xcf/decal-web/"> Source Code </a>
        available on GitHub
      </span>
    </p>
  </div>
  <!-- /.col-lg-12 -->
</footer>

      </div>
    </div>
  </div>

  <script>
    function setCookie(cname, cvalue, exdays) {
      const d = new Date();
      d.setTime(d.getTime() + (exdays*24*60*60*1000));
      let expires = "expires="+ d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for(let i = 0; i <ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    document.getElementById("loading").style["backgroundColor"] = getCookie("dark-mode") == 1 ? "#27262b" : "#ffffff" // Set the opaque layer to the prefered color

    window.addEventListener('load', (event) => {
      document.getElementById("loading").style = ""; // Remove the opaque layer when the page loads
    });


    let dark = !(window.matchMedia && 
    window.matchMedia('(prefers-color-scheme: dark)').matches); // Flip dark so we can run one toggle on load
    
    let preference = getCookie("dark-mode");

    if(preference == "1") {
      dark = false;
    } else if(preference == "0") {
      dark = true;
    }

    let toggleDark = () => { 
      jtd.setTheme(dark ? 'light' : 'dark'); 

      // Change input text placeholder text color

      const PLACEHOLDER_TEXT_COLOR = "#959396";

      if(!dark) {
        let placeholderStyleElem = document.head.appendChild(document.createElement("style"));
        placeholderStyleElem.id = "placeholderTextStyle"
        placeholderStyleElem.innerHTML = "::placeholder { color: " + PLACEHOLDER_TEXT_COLOR + "; opacity: 1 }\n"; // Firefox requires opacity
        placeholderStyleElem.innerHTML += ":-ms-input-placeholder { color: " + PLACEHOLDER_TEXT_COLOR + "; }\n"; // IE 10+
        placeholderStyleElem.innerHTML += "::-ms-input-placeholder { color: " + PLACEHOLDER_TEXT_COLOR + "; }\n"; // Edge
      } else {
        let placeholderStyleElem = document.getElementById("placeholderTextStyle");
        if(placeholderStyleElem) placeholderStyleElem.remove();
      }

      setCookie("dark-mode", dark ? "0" : "1", 3652); 
      dark = !dark;
    }
    toggleDark();
  </script>
</body>
</html>

