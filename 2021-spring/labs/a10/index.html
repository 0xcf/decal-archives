

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="/assets/css/just-the-docs-default.css">

  

  
    <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Lab 10 - Containerization and Docker | Sysadmin DeCal</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Lab 10 - Containerization and Docker" />
<meta name="author" content="Nikhil Jha, Ben Cuan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A course covering the basics of setting up and administering a production-quality Linux server environment." />
<meta property="og:description" content="A course covering the basics of setting up and administering a production-quality Linux server environment." />
<link rel="canonical" href="https://decal.ocf.berkeley.edu/labs/a10/" />
<meta property="og:url" content="https://decal.ocf.berkeley.edu/labs/a10/" />
<meta property="og:site_name" content="Sysadmin DeCal" />
<script type="application/ld+json">
{"headline":"Lab 10 - Containerization and Docker","author":{"@type":"Person","name":"Nikhil Jha, Ben Cuan"},"url":"https://decal.ocf.berkeley.edu/labs/a10/","@type":"WebPage","description":"A course covering the basics of setting up and administering a production-quality Linux server environment.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<span style="display: none">
  
@import "./support/support";
@import "./color_schemes/";
@import "./modules";
@import "./custom/custom";


</span>
<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
      <title>Link</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    </symbol>
  </svg>
  <div class="side-bar lab-side-bar">
    <div class="site-header">
      <a href="/" class="site-title lh-tight">
        Sysadmin DeCal
      </a>
      <a href="#" id="menu-button" class="site-button">
        <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
      </a>
    </div>
    <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">      
      <button type="button" name="theme-toggle" class="btn theme-btn" onclick="toggleDark()">Toggle Dark Theme</button>
      <ol><li><a href="#intro-to-docker">Intro to Docker</a><ol><li><a href="#installing-docker">Installing Docker</a></li><li><a href="#creating-your-first-docker-container">Creating your first Docker container</a></li><li><a href="#running-an-interactive-container">Running an interactive container</a></li><li><a href="#questions-answer-on-gradescope">Questions (answer on Gradescope)</a></li></ol></li><li><a href="#basic-management">Basic Management</a><ol><li><a href="#dockerfiles">Dockerfiles</a><ol><li><a href="#questions">Questions</a></li></ol></li><li><a href="#detached-containers-and-ports">Detached Containers and Ports</a></li></ol></li><li><a href="#dungeons-and-docker-compose">Dungeons and docker-compose</a><ol><li><a href="#about-docker-compose">About docker-compose</a><ol><li><a href="#installing">Installing</a></li><li><a href="#the-web-application">The web application</a></li></ol></li><li><a href="#putting-it-all-together">Putting it all together</a></li><li><a href="#questions-1">Questions</a></li></ol></li><li><a href="#submission">Submission</a></li></ol>

    </nav>
    </div>
  </div>
  <div id="main" class="main">
    <div id="main-content-wrap" class="main-content-wrap">
      
        
      
      <div id="main-content" class="main-content" role="main">
        <h1>Lab 10 - Containerization and Docker</h1>
        
        17 min read
        
          <h2 class="no_toc text-delta" id="table-of-contents">
        
        
          <a href="#table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents
        
        
      </h2>
    

<ol id="markdown-toc">
  <li><a href="#intro-to-docker" id="markdown-toc-intro-to-docker">Intro to Docker</a>    <ol>
      <li><a href="#installing-docker" id="markdown-toc-installing-docker">Installing Docker</a></li>
      <li><a href="#creating-your-first-docker-container" id="markdown-toc-creating-your-first-docker-container">Creating your first Docker container</a></li>
      <li><a href="#running-an-interactive-container" id="markdown-toc-running-an-interactive-container">Running an interactive container</a></li>
      <li><a href="#questions-answer-on-gradescope" id="markdown-toc-questions-answer-on-gradescope">Questions (answer on Gradescope)</a></li>
    </ol>
  </li>
  <li><a href="#basic-management" id="markdown-toc-basic-management">Basic Management</a>    <ol>
      <li><a href="#dockerfiles" id="markdown-toc-dockerfiles">Dockerfiles</a>        <ol>
          <li><a href="#questions" id="markdown-toc-questions">Questions</a></li>
        </ol>
      </li>
      <li><a href="#detached-containers-and-ports" id="markdown-toc-detached-containers-and-ports">Detached Containers and Ports</a></li>
    </ol>
  </li>
  <li><a href="#dungeons-and-docker-compose" id="markdown-toc-dungeons-and-docker-compose">Dungeons and docker-compose</a>    <ol>
      <li><a href="#about-docker-compose" id="markdown-toc-about-docker-compose">About docker-compose</a>        <ol>
          <li><a href="#installing" id="markdown-toc-installing">Installing</a></li>
          <li><a href="#the-web-application" id="markdown-toc-the-web-application">The web application</a></li>
        </ol>
      </li>
      <li><a href="#putting-it-all-together" id="markdown-toc-putting-it-all-together">Putting it all together</a></li>
      <li><a href="#questions-1" id="markdown-toc-questions-1">Questions</a></li>
    </ol>
  </li>
  <li><a href="#submission" id="markdown-toc-submission">Submission</a></li>
</ol><hr />
      <h1 id="intro-to-docker">
        
        
          <a href="#intro-to-docker" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Intro to Docker
        
        
      </h1>
    
<p>This exercise is designed to give you some hands-on experience with Docker!
By the end of this assignment, you should be able to:</p>
<ul>
  <li>Create and use a Docker container interactively</li>
  <li>Create a Dockerfile, which allows you to declaratively define your containers</li>
  <li>Run detached containers and understand port forwarding</li>
  <li>Use <code class="language-plaintext highlighter-rouge">docker-compose</code> to run a multi-container web application</li>
</ul>

<p>Just a forewarning: this lab holds your hand until the last section. Not that the last part is super hard, but it’ll
have a lot less instruction than previous portions which are designed to gently introduce you to Docker.</p>

<!-- This link is not used but will be kept for reference purposes. -->
      <h2 id="installing-docker">
        
        
          <a href="#installing-docker" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installing Docker
        
        
      </h2>
    

<p>Install Docker from the Ubuntu repositories using <code class="language-plaintext highlighter-rouge">sudo apt install docker docker.io</code>.</p>

<p>After installing, check on the status of the docker systemctl service by running <code class="language-plaintext highlighter-rouge">sudo systemctl status docker</code>. If the service is inactivate and/or disabled, run <code class="language-plaintext highlighter-rouge">systemctl enable</code> and <code class="language-plaintext highlighter-rouge">systemctl start</code> to start it up.</p>

<p>I recommend running the command <code class="language-plaintext highlighter-rouge">sudo usermod -aG docker $USER</code> so
you can use Docker as a non-root user. This means you won’t have to type <code class="language-plaintext highlighter-rouge">sudo docker</code> all the time. This is optional
but for the rest of this exercise I’m going to assume that you did this. If you see some output like</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sent invalidate(passwd) request, exiting
sent invalidate(group) request, exiting
</code></pre></div></div>

<p>This is normal, it’s just adding a user to a group.</p>

<p>You’ll have to log out and then log back into your SSH session for the group change to take effect.</p>
      <h2 id="creating-your-first-docker-container">
        
        
          <a href="#creating-your-first-docker-container" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating your first Docker container
        
        
      </h2>
    
<p>To verify that you installed things correctly, try running</p>

<p><code class="language-plaintext highlighter-rouge">docker run hello-world</code></p>

<p>You should see some friendly output like so (hashes are probably different, don’t worry about it):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
b04784fba78d: Already exists
Digest: sha256:f3b3b28a45160805bb16542c9531888519430e9e6d6ffc09d72261b0d26ff74f
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://cloud.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/engine/userguide/
</code></pre></div></div>

<p><strong>If you’re running into an out-of-memory error, the vagrant VM from a6 is probably still running. Try to <code class="language-plaintext highlighter-rouge">cd</code> into the directory where you started the VM, and run <code class="language-plaintext highlighter-rouge">vagrant halt</code> to stop it.</strong></p>

<p>Some <a href="https://docs.docker.com/get-started/#a-brief-explanation-of-containers">quick definitions from Docker’s website:</a></p>

<p>An <strong>image</strong> is a lightweight, stand-alone, executable package that includes everything needed to run a piece of
software, including the code, a runtime, libraries, environment variables, and config files. Images are useful primarily for their
speed, but images can also be used as a base to be built on top of in future images, as you’ll see later with Dockerfiles. In the
last example hello-world was the image used to test our docker installation.</p>

<p>A <strong>container</strong> is a runtime instance of an image—what the image becomes in memory when actually executed.
It runs completely isolated from the host environment by default, only accessing host files and ports if configured to
do so. A container gets created upon executing docker run on an image.</p>

<p>This is similar to the distinction between objects and classes in Object Oriented Programming. Images would be classes,
and containers would be objects.</p>

<p>Be sure to read through the output from running the hello-world image to get an understanding of what the Docker daemon
was doing.</p>
      <h2 id="running-an-interactive-container">
        
        
          <a href="#running-an-interactive-container" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running an interactive container
        
        
      </h2>
    
<p>We’re now going to walk you through running a container interactively. This is useful if you ever need to play around
and install stuff on a bare system without messing up your current system. Try running the following command:</p>

<p><code class="language-plaintext highlighter-rouge">docker run -it ubuntu:xenial /bin/bash</code></p>

<p>The <code class="language-plaintext highlighter-rouge">-i</code> flag tells docker to keep <code class="language-plaintext highlighter-rouge">STDIN</code> open to your container, and the <code class="language-plaintext highlighter-rouge">-t</code> flag allocates a
<a href="https://en.wikipedia.org/wiki/Pseudoterminal">pseudo-TTY</a> for you. Basically you need both for you to have a way to
enter text and have this display properly. At the end of the command, <code class="language-plaintext highlighter-rouge">/bin/bash</code> is just the command you want to run
once the container starts up. Try installing some packages from <code class="language-plaintext highlighter-rouge">apt</code> or just play around. It should look like a bare
Linux system.</p>

<p>You can exit the container with <code class="language-plaintext highlighter-rouge">CTRL+D</code>.</p>

<p>Notice how even though your VM is running the Bionic version of Ubuntu, you were able to run the Xenial version of Ubuntu in a container. If
you are curious about other variants of Linux, you can run a lot of them inside containers as well! This all works because
Linux distributions all share the Linux kernel. For that same reason, you won’t be able to run MacOS or Windows in a container.
You can try running <a href="https://getfedora.org/">Fedora</a> (<em>*tips hat*</em> M’Linux), another long-running Linux distribution:</p>

<p><code class="language-plaintext highlighter-rouge">docker run -it fedora:latest /bin/bash</code></p>
      <h2 id="questions-answer-on-gradescope">
        
        
          <a href="#questions-answer-on-gradescope" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Questions (answer on Gradescope)
        
        
      </h2>
    

<ol>
  <li>What user are you logged in as by default?</li>
  <li>If you start and then exit an interactive container, and then use the <code class="language-plaintext highlighter-rouge">docker run -it ubuntu:xenial /bin/bash</code>
command again, is it the same container? How can you tell?</li>
</ol>
      <h1 id="basic-management">
        
        
          <a href="#basic-management" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Management
        
        
      </h1>
    
<p>The Docker CLI (Command Line Interface) has some basic commands for you to monitor running and stopped containers,
downloaded images, and other information. We’ll go over the basic commands you’ll probably use, but be sure to check
out <a href="https://docs.docker.com/engine/reference/commandline/cli/">the full reference</a> if you’re interested.</p>

<p>Firstly, you might want to see the running containers on a system. Use the following command:</p>

<p><code class="language-plaintext highlighter-rouge">docker ps</code></p>

<p>Since you (likely) have no containers running, you probably won’t see anything interesting. However, if you pass in the
<code class="language-plaintext highlighter-rouge">-a</code> flag, you’ll also be able to see containers that have stopped (make your terminal wider or it’ll display weird):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>baisang@rapture ~/d/labs&gt; docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES
35c048c03588        fedora:latest       "/bin/bash"              7 minutes ago       Exited (130) About a minute ago                       mystifying_edison
dd8f7cc2e0cd        fedora:latest       "/bin/bash"              10 minutes ago      Exited (1) 8 minutes ago                              romantic_mahavira
</code></pre></div></div>

<p>This lets you see a lot of useful information about the container. Observe that each container has a unique container
id and a unique human-readable name. To get more information about a container, you can use the <code class="language-plaintext highlighter-rouge">docker logs</code> command
to fetch the logs of a container (whether it’s still running or exited):</p>

<p><code class="language-plaintext highlighter-rouge">docker logs &lt;container_id_or_name&gt;</code></p>

<p>This basically just gives you <code class="language-plaintext highlighter-rouge">stdout</code> and <code class="language-plaintext highlighter-rouge">stderr</code> for process(es) running in the container.</p>

<p>At some point, you may want to cleanup containers that have exited and you don’t plan on using anymore:</p>

<p><code class="language-plaintext highlighter-rouge">docker rm &lt;container_id_or_name&gt;</code></p>

<p>will remove the container.</p>

<p>You may have noticed when you were running the Ubuntu or Fedora containers the first time that Docker downloaded a good
chunk of data before running the image. This is the image of the container. You can view all of the images you’ve
downloaded with the <code class="language-plaintext highlighter-rouge">docker images</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>baisang@rapture ~/d/labs&gt; docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
fedora              latest              9110ae7f579f        2 weeks ago         235MB
ubuntu              xenial              f975c5035748        3 weeks ago         112MB
</code></pre></div></div>

<p>Images can take up quite a bit of space on your machine, so you may want to clean up images that you don’t plan on
using. This is especially relevant if you get errors about not having enough disk space on your machine:</p>

<p><code class="language-plaintext highlighter-rouge">docker rmi &lt;image_id&gt;</code></p>

<p>The image files, as well as various filesystems of containers, are stored in <code class="language-plaintext highlighter-rouge">/var/lib/docker</code>.</p>

<p>We’ll go over more commands later on in the lab.</p>
      <h2 id="dockerfiles">
        
        
          <a href="#dockerfiles" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dockerfiles
        
        
      </h2>
    
<p>A more powerful way to interface with Docker is by using a Dockerfile. A Dockerfile allows you to define an image by
specifying all of the commands you would type manually to create an image. Docker can then build images from a specified
Dockerfile. These Dockerfiles can be put into version control and the images distributed as a binary to keep track of
both how the image is constructed and also to keep pre-built images around.</p>

<p>Dockerfiles are very powerful and have many different commands and features. We’ll go over a basic example, but you
should check out the <a href="https://docs.docker.com/engine/reference/builder/">reference page</a> if you are trying to do anything more
complex.</p>

<p>Here is an example Dockerfile that will build an image that has <code class="language-plaintext highlighter-rouge">python3.6</code> installed.
It will also run <code class="language-plaintext highlighter-rouge">python3.6</code> directly, so you’ll be at a python prompt instead of a bash prompt when you run it.</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu:bionic</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> python3.6 <span class="nt">--no-install-recommends</span>

<span class="k">CMD</span><span class="s"> ["/usr/bin/python3.6", "-i"]</span>
</code></pre></div></div>

<p>Note: there are some “best practices” for writing Dockerfiles that the above example doesn’t use,
because it’s a basic example. For instance, we probably would want to delete <code class="language-plaintext highlighter-rouge">/var/lib/apt/lists/*</code>, where <code class="language-plaintext highlighter-rouge">apt</code>
stores the package list information from <code class="language-plaintext highlighter-rouge">apt update</code>, after we are done installing packages. We may also choose to use
Linux variants that are smaller and lighter, e.g. Alpine Linux. The general philosophy is
containers should be kept as small and “light” as possible. If you’re interested in this stuff, <a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">check out this
article</a>.</p>

<p>What is this doing? We specify a base image <code class="language-plaintext highlighter-rouge">ubuntu:bionic</code> (release 18.04 of ubuntu).
We then specify that we should run (<code class="language-plaintext highlighter-rouge">RUN</code>) the command <code class="language-plaintext highlighter-rouge">apt-get update</code> and then <code class="language-plaintext highlighter-rouge">apt-get install python3.6</code> so we can
install <code class="language-plaintext highlighter-rouge">python3.6</code>.
Then we set the default command (<code class="language-plaintext highlighter-rouge">CMD</code>) of the container to run the <code class="language-plaintext highlighter-rouge">python3.6</code> interpreter in interactive mode.</p>

<p>Copy the contents of the Dockerfile above into a file named <code class="language-plaintext highlighter-rouge">Dockerfile</code>.
Then use Docker to build it with the following command:</p>

<p><code class="language-plaintext highlighter-rouge">docker build -t mypython:latest .</code></p>

<p>This tells Docker to look in the current directory for a Dockerfile to build, and build it.
The <code class="language-plaintext highlighter-rouge">-t</code> flag tells it to tag this build with the name <code class="language-plaintext highlighter-rouge">mypython:latest</code>.
Docker will look for a Dockerfile in the current directory since you specified <code class="language-plaintext highlighter-rouge">.</code></p>

<p>Remember, you can see all of the images you’ve built on your machine with the <code class="language-plaintext highlighter-rouge">docker images</code> command.</p>
      <h3 id="questions">
        
        
          <a href="#questions" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Questions
        
        
      </h3>
    
<ol>
  <li>Run the image you just built. Since we specified the default <code class="language-plaintext highlighter-rouge">CMD</code>, you can just do <code class="language-plaintext highlighter-rouge">docker run -it
mypython:latest</code>. <strong>What do you observe?</strong></li>
  <li>Write and build a Dockerfile that installs the packages <code class="language-plaintext highlighter-rouge">fortune</code> and <code class="language-plaintext highlighter-rouge">fortunes-min</code> and runs the <code class="language-plaintext highlighter-rouge">fortune</code>
executable (located in <code class="language-plaintext highlighter-rouge">/usr/games/fortune</code> after you install it). Note that you won’t need to use the <code class="language-plaintext highlighter-rouge">-it</code> flags when you run
the container as <code class="language-plaintext highlighter-rouge">fortune</code> doesn’t need <code class="language-plaintext highlighter-rouge">STDIN</code>.
<strong>Submit your Dockerfile with this lab.</strong> <em>Hint:</em> if you’re having trouble writing your Dockerfile, try booting an
interactive container and installing both packages. How can you translate what you did interactively to a Dockerfile?</li>
  <li>Paste the output of your <code class="language-plaintext highlighter-rouge">docker images</code> command after questions 1 and 2.</li>
</ol>
      <h2 id="detached-containers-and-ports">
        
        
          <a href="#detached-containers-and-ports" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Detached Containers and Ports
        
        
      </h2>
    
<p>You might not always want containers to be running interactively. For instance, if you are running a web server, you’ll
likely want the container to continue keep running until you explicitly want to end it. Docker supports this use case
with the <code class="language-plaintext highlighter-rouge">-d</code> flag, which starts containers in <a href="https://docs.docker.com/engine/reference/run/#detached--d">detached
mode</a>.</p>

<p>We’ll explore a bit about detached containers by running a standalone Apache container. The image has already been
built for you; you can find it on <a href="https://hub.docker.com/_/httpd/">Docker Hub</a> as <code class="language-plaintext highlighter-rouge">httpd</code>.</p>

<p>Docker creates a separate virtual network for containers, so you will need to do forward your host port to your
container’s port (this is called <a href="https://en.wikipedia.org/wiki/Port_forwarding">port forwarding</a>, or port mapping).
The container is listening on port 80, so let’s try to forward our host machine’s port 5050 to the container’s
port 80 when we run the container:</p>

<p><code class="language-plaintext highlighter-rouge">docker run -d -p=5050:80 httpd</code></p>

<p>The <code class="language-plaintext highlighter-rouge">-p</code> flag takes in a colon separated pair of <code class="language-plaintext highlighter-rouge">HOST_PORT:CONTAINER_PORT</code> (it can actually accept a ton of more
options, but don’t worry about that for now). You should be able to view visit <code class="language-plaintext highlighter-rouge">&lt;url_of_host_machine&gt;:5050</code>, assuming
you don’t have anything else running on that port (if you’re not on campus, you can just <code class="language-plaintext highlighter-rouge">curl &lt;url_of_host_machine&gt;:5050</code>
from your VM or another machine on campus, e.g. ssh.ocf.berkeley.edu), and see the words “<strong>It works!</strong>”. You may need to allow
the port 5050 on your firewall, simply run the command <code class="language-plaintext highlighter-rouge">ufw allow 5050</code></p>

<p>You can actually “attach” to running containers and run more commands in them, similar to how <code class="language-plaintext highlighter-rouge">docker run</code> works. Use
the <code class="language-plaintext highlighter-rouge">docker exec</code> command:</p>

<p><code class="language-plaintext highlighter-rouge">docker exec &lt;container_id_or_name&gt; &lt;command&gt;</code></p>

<p>To stop this container, use <code class="language-plaintext highlighter-rouge">docker stop &lt;container_id_or_name&gt;</code>.</p>

<p>You can restart the container using <code class="language-plaintext highlighter-rouge">docker restart &lt;container_id_or_name&gt;</code>.</p>
      <h1 id="dungeons-and-docker-compose">
        
        
          <a href="#dungeons-and-docker-compose" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dungeons and docker-compose
        
        
      </h1>
    
<p>Congratulations! You’ve just been hired by some trash SF Bay Area tech bubble startup as their systems administrator.
Unfortunately, both the CEO and CTO are busy handling the business side, which leaves it up to you to get their web
application deployed using Docker and <code class="language-plaintext highlighter-rouge">docker-compose</code>.</p>

<p>Don’t worry though – while you may not have health insurance or a nice salary, you do have some of the CTO’s notes and
equity to help you with your task. You get off BART at 12pm and enter your cramped SOMA coworking space, sitting down
at the desk you share with the CTO while cracking open a cold LaCroix. Checking your email, you find the following
notes from the CTO:</p>
      <h2 id="about-docker-compose">
        
        
          <a href="#about-docker-compose" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> About docker-compose
        
        
      </h2>
    
<p><code class="language-plaintext highlighter-rouge">docker-compose</code> lets you define applications that require more than one container to function. For example, on a web
application you may want your actual web application running inside of a single container, and your database running in
a different container.</p>

<p>Typically you define applications in terms of <strong>services</strong>. Again, going with the web application example, there are
two distinct services: the app itself, and the database backing it. <code class="language-plaintext highlighter-rouge">docker-compose</code> lets you define different services
within a <a href="https://en.wikipedia.org/wiki/YAML">YAML</a> file and run the services accordingly.</p>

<p>One of the nice things about <code class="language-plaintext highlighter-rouge">docker-compose</code> is that it automatically sets up a network for your containers in which:</p>
<ul>
  <li>each container for a service is on the network and reachable from other containers on the network</li>
  <li>each container is discoverable on the network via its container name</li>
</ul>

<p>This means it should be pretty simple to get our web app to connect to the database.</p>
      <h3 id="installing">
        
        
          <a href="#installing" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installing
        
        
      </h3>
    
<p><code class="language-plaintext highlighter-rouge">docker-compose</code> is really just a python package, so ideally we should just install it with <code class="language-plaintext highlighter-rouge">virtualenv</code> and <code class="language-plaintext highlighter-rouge">pip</code> (as with most
things, the version packaged in Ubuntu is too old, so we can’t just <code class="language-plaintext highlighter-rouge">apt install</code> it).
Feel free to do it this way if you want, but since we’re a hotshot tech startup we’re gonna do this the cowboy way
(yeehaw):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo curl -L https://github.com/docker/compose/releases/download/1.27.4/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
</code></pre></div></div>
      <h3 id="the-web-application">
        
        
          <a href="#the-web-application" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The web application
        
        
      </h3>
    
<p>The web application is written only the most badass rockstar tech,
<a href="https://www.youtube.com/watch?v=bzkRVzciAZg">Node.js</a>. For the database, it uses the most webscale, reliable, and
persistent database available on the market today, <a href="https://www.youtube.com/watch?v=b2F-DItXtZs">MongoDB</a>.</p>

<p><img src="https://i.fluffy.cc/bKHw92JKd8fKRgkK73vC881PzkXj4q9V.gif" alt="everything he just said was wrong" /></p>

<p>The web application can be found on GitHub. Note that the web app listens on port 8080, so you’ll need to forward or
expose that port. Don’t forget to allow it on your firewall, <code class="language-plaintext highlighter-rouge">ufw allow 8080</code>. Instructions for setting it up are located in the
<code class="language-plaintext highlighter-rouge">README.md</code> of the repository: <a href="https://github.com/0xcf/decal-sp18-a10">https://github.com/0xcf/decal-sp18-a10</a></p>

<p>For MongoDB, you can just use the image on <a href="https://hub.docker.com/_/mongo/">DockerHub</a> (a website where people can
upload built Docker images). It’s just called <code class="language-plaintext highlighter-rouge">mongo</code>. For example, if you wanted to run MongoDB within a container in
detached mode:</p>

<p><code class="language-plaintext highlighter-rouge">docker run -d mongo:latest</code></p>
      <h2 id="putting-it-all-together">
        
        
          <a href="#putting-it-all-together" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Putting it all together
        
        
      </h2>
    
<p>Your task is to use <code class="language-plaintext highlighter-rouge">docker-compose</code> to deploy the Node.js app with the MongoDB database. The CTO has roughly mapped
out a suggested order of tasks:</p>

<ol>
  <li>Write a <code class="language-plaintext highlighter-rouge">Dockerfile</code> that will allow you to run the Node.js web application</li>
  <li>Write a <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file that will glue the Node.js app container with a MongoDB container</li>
</ol>

<p>Here is a basic skeleton for <code class="language-plaintext highlighter-rouge">docker-compose.yml</code>. You will need to fill out the <code class="language-plaintext highlighter-rouge">web</code> and <code class="language-plaintext highlighter-rouge">database</code> service entries:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '3'
services:
  web:
  database:
</code></pre></div></div>

<p>By default, the Node.js web application is designed to look for a MongoDB instance at hostname <code class="language-plaintext highlighter-rouge">database</code>, so be sure
that your MongoDB service is defined under that name. <code class="language-plaintext highlighter-rouge">docker-compose</code> will make sure that the hostname <code class="language-plaintext highlighter-rouge">database</code> maps
to the container for that service.</p>

<p>One huge caveat: your hotshot CTO unfortunately wrote the Node.js app in a crap way where if it’s not able to connect
to the MongoDB database once it starts, it’ll fail and exit without retrying. Since Javascript is poison, you’ll need
to find a way to make sure that the Node.js app only starts after the MongoDB container is ready to accept incoming
connections <em>without</em> modifying <code class="language-plaintext highlighter-rouge">server.js</code>. I included a wrapper script <code class="language-plaintext highlighter-rouge">wait-for</code> in the repo for the Node.js app
that will allow you to wait for the MongoDB service to be ready before launching the Node.js app. But, in order to use
the script, you will need to have <code class="language-plaintext highlighter-rouge">netcat</code> installed in your container, so be sure to include that in your Dockerfile.
See the <a href="https://github.com/Eficode/wait-for">repo for the script</a> for instructions on how to use the script. Feel free
to come up with other ways to solve this issue though!</p>

<p>You will likely find the <a href="https://docs.docker.com/compose/compose-file/">Compose File Reference</a> useful. Additionally,
the <a href="https://docs.docker.com/compose/gettingstarted/">Getting Started</a> guide will help as well, although it’s a python
example instead of the superior Node.js /s I suggest poking around at other docs on that site also. I expect you to run
into errors and difficulties – this is intended as part of the lab. Feel free to ask in #decal-general if you ever feel especially stuck!</p>

<p><strong>Hints (if you want them):</strong></p>
<ul>
  <li>For the Node.js Dockerfile, I recommend basing it off of <code class="language-plaintext highlighter-rouge">ubuntu:xenial</code> and installing everything you need
(<code class="language-plaintext highlighter-rouge">nodejs</code>, <code class="language-plaintext highlighter-rouge">npm</code>, etc.) via <code class="language-plaintext highlighter-rouge">apt</code>. These aren’t in Debian’s <code class="language-plaintext highlighter-rouge">apt</code> repository so you’d have to find another way to
install them if you use Debian.</li>
  <li><code class="language-plaintext highlighter-rouge">npm install</code> needs to be run within the directory containing the repository (i.e. needs to be run within the
directory that has the <code class="language-plaintext highlighter-rouge">package.json</code> file). If you want to change the current working directory within your
Dockerfile, use the <a href="https://docs.docker.com/engine/reference/builder/#workdir"><code class="language-plaintext highlighter-rouge">WORKDIR</code> command</a></li>
  <li>If you change your Dockerfile after running <code class="language-plaintext highlighter-rouge">docker-compose up</code>, you will need to run <code class="language-plaintext highlighter-rouge">docker-compose build</code> to
rebuild your services</li>
</ul>

<p>Once you’ve set things up properly, just running <code class="language-plaintext highlighter-rouge">docker-compose up</code> in the same directory as the <code class="language-plaintext highlighter-rouge">docker-compose.yml</code>
file will bring up your web application!</p>
      <h2 id="questions-1">
        
        
          <a href="#questions-1" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Questions
        
        
      </h2>
    
<ol>
  <li>Paste your <code class="language-plaintext highlighter-rouge">Dockerfile</code> for the Node.js web application</li>
  <li>Paste your <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file</li>
</ol>
      <h1 id="submission">
        
        
          <a href="#submission" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Submission
        
        
      </h1>
    

<p>Don’t forget to submit to Gradescope!</p>

        
        <hr>
        <footer>
  <div class="col-lg-12 text-center">
    <p>
      <a href="https://www.digitalocean.com" class="no-underline">
        <img
          src="/assets/images/digitalocean.png"
          style="height: 34px; width: 200px"
      /></a>
      <span>
        With great appreciation to
        <a href="https://www.digitalocean.com">DigitalOcean</a> for sponsoring
        the VMs used in both tracks of the DeCal
      </span>
    </p>
    <p>
      <a href="https://www.linode.com" class="no-underline">
        <img
          src="/assets/images/linode.png"
          style="height: 50px; width: 125px"
        />
      </a>
      <span>
        Huge thanks to
        <a href="https://www.linode.com">Linode</a> for sponsoring the equipment
        used to record digital lectures for the Decal
      </span>
    </p>
    <p>
      <a href="https://www.ocf.berkeley.edu" class="no-underline">
        <img
          src="https://www.ocf.berkeley.edu/hosting-logos/ocf-hosted-penguin.svg"
          alt="Hosted by the OCF"
          style="border: 0"
      /></a>
      <span>
        Copyright &copy; 2017-2021
        <a href="https://www.ocf.berkeley.edu"> Open Computing Facility </a>
        and
        <a href="https://xcf.berkeley.edu"> eXperimental Computing Facility </a>
      </span>
    </p>
    <p>
      <span>
        This website and its course materials are licensed under the terms of the
        <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
          CC BY-NC-SA 4.0
        </a>
        License.
        <a href="https://github.com/0xcf/decal-web/"> Source Code </a>
        available on GitHub
      </span>
    </p>
  </div>
  <!-- /.col-lg-12 -->
</footer>

      </div>
    </div>
  </div>
  
</body>

<script>
  let dark = false;
  let toggleDark = () => { jtd.setTheme(dark ? 'light' : 'dark'); dark = !dark; }
</script>
</html>

